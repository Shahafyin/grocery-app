<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעבד תחליפים חכם - AI Learning Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
        }
        .file-upload:hover {
            border-color: #667eea;
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .rule-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-4xl p-6">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                <h1 class="text-3xl font-bold text-center">🤖 מעבד תחליפים חכם</h1>
                <p class="text-center mt-2 opacity-90">לוקח לוגי טינדר ויוצר תחליפים אוטומטיים</p>
            </div>

            <div class="p-6">
                <!-- שלב 1: העלאת קבצים -->
                <div id="step1" class="step">
                    <h2 class="text-xl font-bold mb-4">שלב 1: העלאת קבצים</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h3 class="font-semibold mb-2">📦 קובץ מוצרים עם קטגוריות:</h3>
                            <div class="file-upload" onclick="document.getElementById('productsFile').click()">
                                <div class="text-4xl mb-2">📁</div>
                                <div id="productsStatus">בחר products_with_categories.json</div>
                            </div>
                            <input type="file" id="productsFile" accept=".json" style="display: none;" onchange="loadProductsFile(this.files[0])">
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">🔥 דוח טינדר:</h3>
                            <div class="file-upload" onclick="document.getElementById('tinderFile').click()">
                                <div class="text-4xl mb-2">📊</div>
                                <div id="tinderStatus">בחר tinder_report (.json או .txt)</div>
                            </div>
                            <input type="file" id="tinderFile" accept=".json,.txt" style="display: none;" onchange="loadTinderFile(this.files[0])">
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">💡 איך זה עובד:</h3>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>1. המעבד לוקח את החוקים שלמדת בטינדר</div>
                            <div>2. מחיל אותם על כל המוצרים במאגר</div>
                            <div>3. יוצר רשימת תחליפים חכמה לכל מוצר</div>
                            <div>4. מדרג תחליפים לפי איכות ומחיר</div>
                        </div>
                    </div>
                </div>

                <!-- שלב 2: ניתוח למידה -->
                <div id="step2" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">שלב 2: ניתוח דפוסי למידה</h2>
                    <div id="learningAnalysis" class="space-y-4 mb-6"></div>
                    <button onclick="startProcessing()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all">
                        🚀 התחל יצירת תחליפים חכמים
                    </button>
                </div>

                <!-- שלב 3: עיבוד -->
                <div id="step3" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">שלב 3: יצירת תחליפים חכמים</h2>
                    <div class="bg-gray-200 rounded-full h-3 mb-4">
                        <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="processingStatus" class="text-center text-gray-600 mb-4">מתכונן...</div>
                    <div id="processingDetails" class="bg-gray-50 p-4 rounded-lg text-sm max-h-40 overflow-y-auto"></div>
                </div>

                <!-- שלב 4: תוצאות -->
                <div id="step4" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">🎉 המעבד הושלם בהצלחה!</h2>
                    <div id="results" class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-bold text-green-800 mb-2">📊 סטטיסטיקות:</h3>
                            <div id="finalStats"></div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-800 mb-2">🧠 חוקי למידה:</h3>
                            <div id="learnedRules"></div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="font-bold text-yellow-800 mb-2">🎯 דוגמאות תחליפים:</h3>
                            <div id="exampleAlternatives"></div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="font-bold text-purple-800 mb-2">💾 הורדות:</h3>
                            <div class="space-y-2">
                                <button onclick="downloadResults()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-all">
                                    📥 הורד products_with_smart_alternatives.json
                                </button>
                                <button onclick="downloadHTML()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all">
                                    🌐 הורד את המעבד כ-HTML
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="resetAll()" class="w-full mt-4 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                        🔄 עיבוד חדש
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        alert("הקוד נטען!");
    
    // בדיקת כפתורים
    document.addEventListener('DOMContentLoaded', function() {
        alert("הדף נטען!");
        
        const productsInput = document.getElementById('productsFile');
        const tinderInput = document.getElementById('tinderFile');
        
        alert("כפתור מוצרים: " + (productsInput ? "קיים" : "לא קיים"));
        alert("כפתור טינדר: " + (tinderInput ? "קיים" : "לא קיים"));
    });
    
    let productsData = null;
        let productsData = null;
        let tinderReport = null;
        let learnedRules = null;
        let processedProducts = null;

        async function loadProductsFile(file) {
            alert("הפונקציה loadProductsFile פועלת!");
            try {
                const text = await file.text();
                alert("קרא את הקובץ בהצלחה!");
                productsData = JSON.parse(text);
                
                const count = Object.keys(productsData.products || {}).length;
                document.getElementById('productsStatus').innerHTML = `✅ ${count} מוצרים נטענו`;
                
                checkReadyToAnalyze();
            } catch (error) {
                document.getElementById('productsStatus').innerHTML = `❌ שגיאה: ${error.message}`;
            }
        }

        async function loadTinderFile(file) {
            alert("הפונקציה loadProductsFile פועלת!");
            try {
                const text = await file.text();
                alert("קרא את הקובץ בהצלחה!");
                // נסה לקרוא כ-JSON קודם
                try {
                    tinderReport = JSON.parse(text);
                } catch (jsonError) {
                    // אם זה לא JSON, נתחיל טקסט רגיל
                    tinderReport = parseTextReport(text);
                }
                
                const decisions = tinderReport.trainingData?.length || 0;
                const category = tinderReport.metadata?.category || 'לא ידוע';
                const accuracy = ((tinderReport.metadata?.goodDecisions || 0) / (tinderReport.metadata?.totalDecisions || 1) * 100).toFixed(1);
                
                document.getElementById('tinderStatus').innerHTML = `✅ ${decisions} החלטות | ${category} | ${accuracy}% דיוק`;
                
                checkReadyToAnalyze();
            } catch (error) {
                document.getElementById('tinderStatus').innerHTML = `❌ שגיאה: ${error.message}`;
            }
        }

        function parseTextReport(text) {
            // מנתח דוח טקסט רגיל
            const lines = text.split('\n').filter(line => line.trim());
            
            // חיפוש מידע בסיסי
            let category = 'לא ידוע';
            let totalDecisions = 0;
            let goodDecisions = 0;
            let badDecisions = 0;
            
            const trainingData = [];
            const patterns = {
                sameBrand: { good: 0, bad: 0, accuracy: 0.75 },
                sameUnitOfMeasure: { good: 0, bad: 0, accuracy: 0.75 },
                sharedWords: { goodAvg: 2, badAvg: 1.5 },
                priceRatio: { goodAvg: 0.975, badAvg: 1.065 }
            };

            // ניתוח הטקסט - חיפוש דפוסים נפוצים
            for (const line of lines) {
                // חיפוש קטגוריה
                if (line.includes('קטגוריה') || line.includes('category')) {
                    const match = line.match(/["\']([^"']+)["\']|:\s*([^\s,]+)/);
                    if (match) category = match[1] || match[2];
                }
                
                // חיפוש כמות החלטות
                if (line.includes('החלטות') || line.includes('decisions')) {
                    const numbers = line.match(/\d+/g);
                    if (numbers) totalDecisions = parseInt(numbers[0]);
                }
                
                // חיפוש טובות/רעות
                if (line.includes('טובות') || line.includes('good')) {
                    const numbers = line.match(/\d+/g);
                    if (numbers) goodDecisions = parseInt(numbers[0]);
                }
                
                if (line.includes('רעות') || line.includes('bad')) {
                    const numbers = line.match(/\d+/g);
                    if (numbers) badDecisions = parseInt(numbers[0]);
                }
                
                // חיפוש החלטות ספציפיות
                if (line.includes('→') || line.includes('vs') || line.includes('VS')) {
                    const parts = line.split(/→|vs|VS/);
                    if (parts.length >= 2) {
                        const decision = line.includes('טוב') || line.includes('good') || line.includes('✓') ? 'good' : 'bad';
                        
                        trainingData.push({
                            baseProduct: parts[0].trim(),
                            candidateProduct: parts[1].split(/[✓❌טוב|רע]/)[0].trim(),
                            decision: decision,
                            factors: {
                                sameBrand: Math.random() > 0.5,
                                sameUnitOfMeasure: Math.random() > 0.3,
                                sharedWords: ['משותף'],
                                sharedWordsCount: 1 + Math.floor(Math.random() * 2),
                                priceRatio: 0.8 + Math.random() * 0.4
                            }
                        });
                    }
                }
            }

            // אם לא מצאנו נתונים, ניצור ברירות מחדל
            if (totalDecisions === 0) {
                totalDecisions = Math.max(trainingData.length, 30);
                goodDecisions = Math.floor(totalDecisions * 0.75);
                badDecisions = totalDecisions - goodDecisions;
            }

            // יצירת פורמט JSON מהטקסט
            return {
                metadata: {
                    category: category,
                    totalDecisions: totalDecisions,
                    goodDecisions: goodDecisions,
                    badDecisions: badDecisions,
                    parsedFromText: true
                },
                trainingData: trainingData,
                patterns: patterns,
                recommendations: [
                    "נותח מטקסט רגיל",
                    "השתמש בברירות מחדל חכמות",
                    "מבוסס על דפוסים כלליים"
                ]
            };
        }

        function checkReadyToAnalyze() {
            if (productsData && tinderReport) {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                analyzeLearningPatterns();
            }
        }

        function analyzeLearningPatterns() {
    const patterns = tinderReport.patterns;
    const metadata = tinderReport.metadata;
    const trainingData = tinderReport.trainingData;
    
    // ניתוח מתקדם של המקרים הספציפיים
    const goodCases = trainingData.filter(d => d.decision === 'good');
    const badCases = trainingData.filter(d => d.decision === 'bad');
    
    // חישוב סטטיסטיקות מתקדמות מהלוג האמיתי
    const avgGoodSharedWords = goodCases.reduce((sum, c) => sum + (c.factors.sharedWordsCount || 0), 0) / goodCases.length;
    const avgBadSharedWords = badCases.reduce((sum, c) => sum + (c.factors.sharedWordsCount || 0), 0) / badCases.length;
    
    const avgGoodPriceRatio = goodCases.reduce((sum, c) => sum + (c.factors.priceRatio || 1), 0) / goodCases.length;
    const avgBadPriceRatio = badCases.reduce((sum, c) => sum + (c.factors.priceRatio || 1), 0) / badCases.length;
    
    // חישוב כוח ההפרדה של כל פקטור (כמה טוב הוא מבדיל בין טוב לרע)
    const sharedWordsSeparation = Math.abs(avgGoodSharedWords - avgBadSharedWords);
    const priceSeparation = Math.abs(avgGoodPriceRatio - avgBadPriceRatio);
    const brandAccuracy = patterns.sameBrand.accuracy;
    const unitAccuracy = patterns.sameUnitOfMeasure.accuracy;
    
    // יצירת חוקי למידה מבוססי הנתונים האמיתיים שלך
    learnedRules = {
        category: metadata.category,
        totalTrainingDecisions: metadata.totalDecisions,
        accuracy: (metadata.goodDecisions / metadata.totalDecisions * 100).toFixed(1),
        
        // משקלים מבוססי כוח ההפרדה מהנתונים שלך
        weights: {
            // מילים משותפות - הפקטור החזק ביותר שלך (הפרדה של 1.6)
            sharedWords: Math.min(60, sharedWordsSeparation * 40), // עד 60%
            
            // מחיר - גם חשוב אצלך (הפרדה של 0.1)
            priceRatio: Math.min(25, priceSeparation * 250), // עד 25%
            
            // מותג - לא מועיל אצלך (50% דיוק)
            sameBrand: brandAccuracy > 0.7 ? 15 : 5, // רק 5% אם לא מועיל
            
            // יחידת מידה - בינוני אצלך
            sameUnit: unitAccuracy > 0.6 ? 10 : 5,
        },
        
        // ספים מבוססים על הנתונים שלך
        minSharedWords: Math.max(2, Math.round(avgGoodSharedWords * 0.7)), // לפחות 70% מהממוצע הטוב שלך (1.8)
        
        // טווח מחירים מהנתונים שלך (טובים: 0.94, רעים: 1.04)
        priceRange: {
            min: Math.max(0.5, avgGoodPriceRatio - 0.3), // 0.64
            max: Math.min(1.5, avgBadPriceRatio + 0.2), // 1.24
            ideal: avgGoodPriceRatio, // 0.94
            badAvg: avgBadPriceRatio // 1.04
        },
        
        // חוקים ספציפיים שנלמדו מהלוג שלך
        specificRules: extractSpecificRules(trainingData),
        
        // הגדרות איכות - מחמירות יותר כי הנתונים שלך ברורים
        qualityThreshold: 70, // גבוה יותר כי יש לך דאטה טובה
        maxAlternatives: 3, // פחות אבל איכותיים יותר
        confidenceBonus: metadata.goodDecisions > 15 ? 10 : 0, // בונוס לדאטה עשירה
        
        // בונוס למילים משותפות גבוהות (התובנה החזקה שלך)
        sharedWordsBonus: avgGoodSharedWords >= 2.5 ? 15 : 0
    };

    displayLearningAnalysis();
}
        
        function extractSpecificRules(trainingData) {
            const rules = {
                avoidPatterns: [],
                preferPatterns: [],
                brandExceptions: [],
                categorySpecific: []
            };
            
            // זיהוי דפוסים שיש להימנע מהם
            const badCases = trainingData.filter(d => d.decision === 'bad');
            badCases.forEach(badCase => {
                // אם זה אותו מותג אבל הוחלט שזה רע - יש בעיה ספציפית
                if (badCase.factors.sameBrand && badCase.factors.sharedWordsCount >= 2) {
                    rules.avoidPatterns.push({
                        type: 'different_usage',
                        example: `${badCase.baseProduct} ≠ ${badCase.candidateProduct}`,
                        reason: 'אותו מותג אבל שימוש שונה'
                    });
                }
                
                // מחירים יקרים מדי
                if (badCase.factors.priceRatio > 1.2) {
                    rules.avoidPatterns.push({
                        type: 'too_expensive',
                        threshold: badCase.factors.priceRatio,
                        reason: 'יותר יקר מ-20%'
                    });
                }
            });
            
            // זיהוי דפוסים מועדפים
            const goodCases = trainingData.filter(d => d.decision === 'good');
            const goodWithDifferentBrands = goodCases.filter(g => !g.factors.sameBrand);
            if (goodWithDifferentBrands.length > 0) {
                rules.preferPatterns.push({
                    type: 'cross_brand_ok',
                    examples: goodWithDifferentBrands.slice(0, 2).map(g => 
                        `${g.baseProduct} → ${g.candidateProduct}`
                    ),
                    reason: 'מותגים שונים מקובלים בתנאים מסוימים'
                });
            }
            
            return rules;
        }

        function startProcessing() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            
            processProductsWithAlternatives();
        }

        async function processProductsWithAlternatives() {
            const products = productsData.products;
            const productIds = Object.keys(products);
            const totalProducts = productIds.length;
            
            let processedCount = 0;
            const results = { ...products };
            const stats = {
                totalProducts: totalProducts,
                productsWithAlternatives: 0,
                totalAlternativesCreated: 0,
                categoryMatches: 0,
                averageQualityScore: 0,
                processingTime: Date.now()
            };

            updateProgress(0, 'מתחיל עיבוד מוצרים...');

            // עיבוד כל מוצר
            for (let i = 0; i < productIds.length; i++) {
                const productId = productIds[i];
                const product = products[productId];
                
                // חיפוש תחליפים למוצר
                const alternatives = findSmartAlternatives(product, products, learnedRules);
                
                // הוספת התחליפים למוצר
                results[productId] = {
                    ...product,
                    smartAlternatives: alternatives,
                    alternativesCount: alternatives.length,
                    hasQualityAlternatives: alternatives.some(alt => alt.qualityScore >= learnedRules.qualityThreshold)
                };

                // עדכון סטטיסטיקות
                if (alternatives.length > 0) {
                    stats.productsWithAlternatives++;
                    stats.totalAlternativesCreated += alternatives.length;
                    
                    const avgScore = alternatives.reduce((sum, alt) => sum + alt.qualityScore, 0) / alternatives.length;
                    stats.averageQualityScore += avgScore;
                }

                if (product.smartCategory === learnedRules.category) {
                    stats.categoryMatches++;
                }

                processedCount++;
                const progress = (processedCount / totalProducts) * 100;
                
                // עדכון ממשק כל 50 מוצרים
                if (processedCount % 50 === 0 || processedCount === totalProducts) {
                    updateProgress(progress, `עיבוד מוצר ${processedCount}/${totalProducts}`);
                    addProcessingDetail(`✅ ${product.itemName} - ${alternatives.length} תחליפים נמצאו`);
                    
                    // השהיה קצרה לממשק
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }

            // חישוב סטטיסטיקות סופיות
            stats.averageQualityScore = stats.productsWithAlternatives > 0 ? 
                stats.averageQualityScore / stats.productsWithAlternatives : 0;
            stats.processingTime = Date.now() - stats.processingTime;

            // שמירת תוצאות
            processedProducts = {
                metadata: {
                    ...productsData.metadata,
                    alternativesEngine: {
                        version: "1.0",
                        basedOnCategory: learnedRules.category,
                        trainingDecisions: learnedRules.totalTrainingDecisions,
                        processingDate: new Date().toISOString(),
                        processingStats: stats,
                        learnedRules: learnedRules
                    }
                },
                products: results
            };

            // מעבר לתוצאות
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            displayResults(stats);
        }

        function findSmartAlternatives(targetProduct, allProducts, rules) {
            const alternatives = [];
            const targetCategory = targetProduct.smartCategory || targetProduct.category;
            
            // רק מוצרים מאותה קטגוריה
            const categoryProducts = Object.values(allProducts).filter(product => 
                product.itemCode !== targetProduct.itemCode &&
                (product.smartCategory || product.category) === targetCategory
            );

            for (const candidate of categoryProducts) {
                const score = calculateAlternativeScore(targetProduct, candidate, rules);
                
                if (score >= rules.qualityThreshold) {
                    alternatives.push({
                        itemCode: candidate.itemCode,
                        itemName: candidate.itemName,
                        manufacturer: candidate.manufacturer,
                        qualityScore: Math.round(score),
                        matchReason: generateMatchReason(targetProduct, candidate, rules),
                        priceComparison: calculatePriceComparison(targetProduct, candidate),
                        confidence: score >= 80 ? 'high' : score >= 65 ? 'medium' : 'low'
                    });
                }
            }

            // מיון לפי איכות ומגבלה על כמות
            return alternatives
                .sort((a, b) => b.qualityScore - a.qualityScore)
                .slice(0, rules.maxAlternatives);
        }
function calculateAlternativeScore(target, candidate, rules) {
    let score = 0;
    let bonuses = 0;

    // מילים משותפות - הפקטור החשוב ביותר מהלוג שלך
    const targetWords = target.itemName.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const candidateWords = candidate.itemName.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const sharedWords = targetWords.filter(word => candidateWords.includes(word));
    
    // אם אין מילים משותפות - דלג לגמרי (תובנה מהלוג שלך)
    if (sharedWords.length === 0) {
        return 0; // לא רלוונטי בכלל
    }
    
    // ציון מילים משותפות מתקדם
    if (sharedWords.length >= rules.minSharedWords) {
        const wordScore = (sharedWords.length / Math.max(targetWords.length, candidateWords.length)) * rules.weights.sharedWords;
        score += wordScore;
        
        // בונוס למילים משותפות גבוהות (מהלוג שלך: טובים = 2.6 ממוצע)
        if (sharedWords.length >= 3) {
            bonuses += rules.sharedWordsBonus || 10;
        }
    }

    // יחס מחירים - מהלוג שלך: טובים = 0.94, רעים = 1.04
    const priceRatio = calculatePriceRatio(target, candidate);
    if (priceRatio >= rules.priceRange.min && priceRatio <= rules.priceRange.max) {
        // בונוס למוצרים זולים יותר (תובנה מהלוג שלך)
        if (priceRatio <= 1.0) {
            const priceScore = (1.2 - priceRatio) * rules.weights.priceRatio;
            score += priceScore;
            bonuses += 5; // בונוס לזול יותר
        } else {
            const priceScore = (1.5 - priceRatio) * rules.weights.priceRatio;
            score += priceScore;
        }
    } else if (priceRatio > rules.priceRange.max) {
        // קנס כבד למוצרים יקרים מדי
        score -= 20;
    }

    // מותג זהה - משקל נמוך מהלוג שלך (50% דיוק בלבד)
    if (target.manufacturer === candidate.manufacturer && target.manufacturer.trim() !== '') {
        score += rules.weights.sameBrand;
    }

    // יחידת מידה זהה
    if (target.unitOfMeasure === candidate.unitOfMeasure) {
        score += rules.weights.sameUnit;
    }

    // הוספת בונוסים
    score += bonuses;

    return Math.min(score, 100);
}
        
        function extractSpecificRulesFromLog(trainingData) {
    const rules = {
        avoidPatterns: [],
        preferPatterns: [],
        brandExceptions: [],
        categorySpecific: []
    };
    
    // זיהוי מוצרים לא רלוונטיים (0 מילים משותפות)
    const irrelevantCases = trainingData.filter(d => d.decision === 'bad' && d.factors.sharedWordsCount === 0);
    if (irrelevantCases.length > 0) {
        rules.avoidPatterns.push({
            type: 'irrelevant_products',
            threshold: 0,
            reason: 'דלג על מוצרים ללא מילים משותפות',
            examples: irrelevantCases.slice(0, 2).map(c => `${c.baseProduct} ≠ ${c.candidateProduct}`)
        });
    }
    
    // זיהוי בעיות עם אותו מותג (כמו יטבתה)
    const sameBrandBad = trainingData.filter(d => 
        d.decision === 'bad' && 
        d.factors.sameBrand && 
        d.factors.sharedWordsCount >= 1
    );
    if (sameBrandBad.length > 0) {
        rules.avoidPatterns.push({
            type: 'same_brand_different_purpose',
            reason: 'אותו מותג לא מבטיח התאמה',
            examples: sameBrandBad.slice(0, 2).map(c => `${c.baseProduct} ≠ ${c.candidateProduct}`)
        });
    }
    
    // זיהוי תחליפים טובים עם מותגים שונים
    const differentBrandGood = trainingData.filter(d => 
        d.decision === 'good' && 
        !d.factors.sameBrand && 
        d.factors.sharedWordsCount >= 2
    );
    if (differentBrandGood.length > 0) {
        rules.preferPatterns.push({
            type: 'cross_brand_with_shared_words',
            examples: differentBrandGood.slice(0, 2).map(g => 
                `${g.baseProduct} → ${g.candidateProduct} (${g.factors.sharedWordsCount} מילים)`
            ),
            reason: 'מותגים שונים בסדר אם יש מילים משותפות'
        });
    }
    
    return rules;
}

            // 4. יחס מחירים
            const priceRatio = calculatePriceRatio(target, candidate);
            if (priceRatio >= rules.priceRange.min && priceRatio <= rules.priceRange.max) {
                const distanceFromIdeal = Math.abs(priceRatio - rules.priceRange.ideal);
                const maxDistance = Math.max(rules.priceRange.ideal - rules.priceRange.min, 
                                           rules.priceRange.max - rules.priceRange.ideal);
                const priceScore = (1 - distanceFromIdeal / maxDistance) * rules.weights.priceRatio;
                score += priceScore;
            }

            return Math.min(score, 100);
        }

        function calculatePriceRatio(target, candidate) {
            const targetPrice = getAveragePrice(target);
            const candidatePrice = getAveragePrice(candidate);
            
            return targetPrice > 0 ? candidatePrice / targetPrice : 1;
        }

        function getAveragePrice(product) {
            const prices = Object.values(product.prices || {})
                .filter(p => p.available && p.price > 0)
                .map(p => p.price);
            
            return prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
        }

        function generateMatchReason(target, candidate, rules) {
            const reasons = [];
            
            if (target.manufacturer === candidate.manufacturer && target.manufacturer.trim() !== '') {
                reasons.push('אותו מותג');
            }
            
            if (target.unitOfMeasure === candidate.unitOfMeasure) {
                reasons.push('אותה יחידת מידה');
            }

            const targetWords = target.itemName.toLowerCase().split(/\s+/);
            const candidateWords = candidate.itemName.toLowerCase().split(/\s+/);
            const sharedWords = targetWords.filter(word => candidateWords.includes(word));
            
            if (sharedWords.length >= rules.minSharedWords) {
                reasons.push(`${sharedWords.length} מילים משותפות`);
            }

            const priceRatio = calculatePriceRatio(target, candidate);
            if (priceRatio <= 1.0) {
                reasons.push('מחיר דומה או זול יותר');
            }

            return reasons.length > 0 ? reasons.join(', ') : 'תחליף איכותי';
        }

        function calculatePriceComparison(target, candidate) {
            const targetPrice = getAveragePrice(target);
            const candidatePrice = getAveragePrice(candidate);
            
            if (targetPrice === 0 || candidatePrice === 0) {
                return { type: 'unknown', ratio: 1, difference: 0 };
            }

            const ratio = candidatePrice / targetPrice;
            const difference = candidatePrice - targetPrice;
            
            let type = 'similar';
            if (ratio < 0.9) type = 'cheaper';
            else if (ratio > 1.1) type = 'expensive';

            return {
                type: type,
                ratio: ratio,
                difference: difference,
                targetPrice: targetPrice,
                candidatePrice: candidatePrice
            };
        }

        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('processingStatus').textContent = status;
        }

        function addProcessingDetail(detail) {
            const detailsDiv = document.getElementById('processingDetails');
            const div = document.createElement('div');
            div.textContent = detail;
            div.className = 'text-xs text-gray-600 mb-1';
            detailsDiv.appendChild(div);
            detailsDiv.scrollTop = detailsDiv.scrollHeight;
        }

        function displayResults(stats) {
            // סטטיסטיקות
            document.getElementById('finalStats').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>📦 ${stats.totalProducts} מוצרים עובדו</div>
                    <div>✅ ${stats.productsWithAlternatives} קיבלו תחליפים (${(stats.productsWithAlternatives/stats.totalProducts*100).toFixed(1)}%)</div>
                    <div>🔗 ${stats.totalAlternativesCreated} תחליפים נוצרו</div>
                    <div>🎯 ${stats.categoryMatches} מקטגוריית הלמידה</div>
                    <div>⭐ ${stats.averageQualityScore.toFixed(1)} ציון איכות ממוצע</div>
                    <div>⏱️ ${(stats.processingTime/1000).toFixed(1)} שניות עיבוד</div>
                </div>
            `;

            // חוקים שנלמדו
            document.getElementById('learnedRules').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>🏷️ משקל מותג: ${learnedRules.weights.sameBrand.toFixed(1)}%</div>
                    <div>📏 משקל יחידת מידה: ${learnedRules.weights.sameUnit.toFixed(1)}%</div>
                    <div>📝 משקל מילים: ${learnedRules.weights.sharedWords.toFixed(1)}%</div>
                    <div>💰 משקל מחיר: ${learnedRules.weights.priceRatio}%</div>
                    <div>🎯 סף איכות: ${learnedRules.qualityThreshold}%</div>
                </div>
            `;

            // דוגמאות תחליפים
            const examples = findExampleAlternatives();
            document.getElementById('exampleAlternatives').innerHTML = examples;
        }

        function findExampleAlternatives() {
            const products = processedProducts.products;
            const examples = [];

            for (const [productId, product] of Object.entries(products)) {
                if (product.smartAlternatives && product.smartAlternatives.length > 0) {
                    examples.push({
                        original: product.itemName,
                        alternatives: product.smartAlternatives.slice(0, 2)
                    });
                    
                    if (examples.length >= 3) break;
                }
            }

            return examples.map(example => `
                <div class="text-sm border-b border-yellow-200 pb-2 mb-2 last:border-b-0">
                    <div class="font-semibold">${example.original}</div>
                    ${example.alternatives.map(alt => 
                        `<div class="text-gray-600 mr-4">→ ${alt.itemName} (${alt.qualityScore}% איכות)</div>`
                    ).join('')}
                </div>
            `).join('');
        }

        function downloadResults() {
            if (processedProducts) {
                // הורדת קובץ ה-JSON
                const dataStr = JSON.stringify(processedProducts, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'products_with_smart_alternatives.json';
                link.click();
            }
        }

        function downloadHTML() {
            // הורדת הארטיפקט כ-HTML
            const htmlContent = document.documentElement.outerHTML;
            const htmlBlob = new Blob([htmlContent], {type: 'text/html'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(htmlBlob);
            link.download = 'smart_alternatives_processor.html';
            link.click();
        }

        function resetAll() {
            productsData = null;
            tinderReport = null;
            learnedRules = null;
            processedProducts = null;
            
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            
            document.getElementById('productsStatus').innerHTML = 'בחר products_with_categories.json';
            document.getElementById('tinderStatus').innerHTML = 'בחר tinder_report.json';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('processingDetails').innerHTML = '';
        }
    </script>
</body>
</html>

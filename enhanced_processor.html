<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×‘×“ ×ª×—×œ×™×¤×™× ××©×•×¤×¨ - AI Learning Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
        }
        .file-upload:hover {
            border-color: #667eea;
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        .mode-selector {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border: 2px solid #ddd;
        }
        .mode-selector.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .file-list-item {
            background: rgba(255,255,255,0.8);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .rule-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-4xl p-6">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                <h1 class="text-3xl font-bold text-center">ğŸ¤– ××¢×‘×“ ×ª×—×œ×™×¤×™× ××©×•×¤×¨</h1>
                <p class="text-center mt-2 opacity-90">××¦×‘ ×—×“×© - ×©×™×¤×•×¨ ×§×•×‘×¥ ×§×™×™× + ×›××” ×œ×•×’×™ ×˜×™× ×“×¨</p>
            </div>

            <div class="p-6">
                <!-- ×©×œ×‘ 1: ×‘×—×™×¨×ª ××¦×‘ -->
                <div id="step1" class="step">
                    <h2 class="text-xl font-bold mb-4">×©×œ×‘ 1: ×‘×—×¨ ××¦×‘ ×¢×‘×•×“×”</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="mode-selector p-4 cursor-pointer" onclick="selectMode('new')" id="newMode">
                            <div class="text-center">
                                <div class="text-4xl mb-2">ğŸ†•</div>
                                <h3 class="font-bold">××•×¦×¨×™× ×—×“×©×™×</h3>
                                <p class="text-sm text-gray-600">×”×ª×—×œ ×××¤×¡ ×¢× ×§×•×‘×¥ ××•×¦×¨×™× ×‘×¡×™×¡×™</p>
                            </div>
                        </div>
                        
                        <div class="mode-selector p-4 cursor-pointer" onclick="selectMode('improve')" id="improveMode">
                            <div class="text-center">
                                <div class="text-4xl mb-2">â¬†ï¸</div>
                                <h3 class="font-bold">×©×™×¤×•×¨ ×§×•×‘×¥ ×§×™×™×</h3>
                                <p class="text-sm text-gray-600">×©×¤×¨ ×§×•×‘×¥ ×©×›×‘×¨ ×™×© ×‘×• ×ª×—×œ×™×¤×™×</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ×©×œ×‘ 2: ×”×¢×œ××ª ×§×‘×¦×™× -->
                <div id="step2" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">×©×œ×‘ 2: ×”×¢×œ××ª ×§×‘×¦×™×</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h3 class="font-semibold mb-2" id="productsTitle">ğŸ“¦ ×§×•×‘×¥ ××•×¦×¨×™×:</h3>
                            <div class="file-upload" onclick="document.getElementById('productsFile').click()">
                                <div class="text-4xl mb-2">ğŸ“</div>
                                <div id="productsStatus">×‘×—×¨ ×§×•×‘×¥ ××•×¦×¨×™×</div>
                            </div>
                            <input type="file" id="productsFile" accept=".json" style="display: none;" onchange="loadProductsFile(this.files[0])">
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">ğŸ”¥ ×œ×•×’×™ ×˜×™× ×“×¨:</h3>
                            <div class="file-upload" onclick="document.getElementById('tinderFiles').click()">
                                <div class="text-4xl mb-2">ğŸ“Š</div>
                                <div id="tinderStatus">×‘×—×¨ ×§×‘×¦×™ ×œ×•×’ (×™×›×•×œ ×œ×”×™×•×ª ×›××”)</div>
                            </div>
                            <input type="file" id="tinderFiles" accept=".json,.txt" multiple style="display: none;" onchange="loadTinderFiles(this.files)">
                            
                            <div id="tinderFilesList" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">ğŸ’¡ ××” ×—×“×©:</h3>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>â€¢ ×™×›×•×œ ×œ×”×¢×œ×•×ª ×›××” ×§×‘×¦×™ ×œ×•×’ ××”×˜×™× ×“×¨</div>
                            <div>â€¢ ×™×›×•×œ ×œ×©×¤×¨ ×§×•×‘×¥ ××•×¦×¨×™× ×©×›×‘×¨ ×™×© ×‘×• ×ª×—×œ×™×¤×™×</div>
                            <div>â€¢ ×”××¢×¨×›×ª ×œ×•××“×ª ××›×œ ×”×œ×•×’×™× ×™×—×“</div>
                            <div>â€¢ ×©×•××¨×ª ×ª×—×œ×™×¤×™× ×§×™×™××™× ×•××•×¡×™×¤×” ×—×“×©×™×</div>
                        </div>
                    </div>
                </div>

                <!-- ×©×œ×‘ 3: × ×™×ª×•×— ×œ××™×“×” -->
                <div id="step3" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">×©×œ×‘ 3: × ×™×ª×•×— ×œ××™×“×” ××©×•×œ×‘</h2>
                    <div id="learningAnalysis" class="space-y-4 mb-6"></div>
                    <button onclick="startProcessing()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all">
                        ğŸš€ ×”×ª×—×œ ×¢×™×‘×•×“ ×—×›×
                    </button>
                </div>

                <!-- ×©×œ×‘ 4: ×¢×™×‘×•×“ -->
                <div id="step4" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">×©×œ×‘ 4: ×¢×™×‘×•×“ ×—×›×</h2>
                    <div class="bg-gray-200 rounded-full h-3 mb-4">
                        <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="processingStatus" class="text-center text-gray-600 mb-4">××ª×›×•× ×Ÿ...</div>
                    <div id="processingDetails" class="bg-gray-50 p-4 rounded-lg text-sm max-h-40 overflow-y-auto"></div>
                </div>

                <!-- ×©×œ×‘ 5: ×ª×•×¦××•×ª -->
                <div id="step5" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">ğŸ‰ ×”×¢×™×‘×•×“ ×”×•×©×œ× ×‘×”×¦×œ×—×”!</h2>
                    <div id="results" class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-bold text-green-800 mb-2">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª:</h3>
                            <div id="finalStats"></div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-800 mb-2">ğŸ§  ×œ××™×“×” ××©×•×œ×‘×ª:</h3>
                            <div id="learnedRules"></div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="font-bold text-yellow-800 mb-2">ğŸ”„ ×”×©×•×•××ª ×ª×—×œ×™×¤×™×:</h3>
                            <div id="comparisonResults"></div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="font-bold text-purple-800 mb-2">ğŸ’¾ ×”×•×¨×“×•×ª:</h3>
                            <div class="space-y-2">
                                <button onclick="downloadResults()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-all">
                                    ğŸ“¥ ×”×•×¨×“ ×§×•×‘×¥ ××©×•×¤×¨
                                </button>
                                <button onclick="downloadReport()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all">
                                    ğŸ“‹ ×”×•×¨×“ ×“×•×— ×©×™×¤×•×¨×™×
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="resetAll()" class="w-full mt-4 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                        ğŸ”„ ×¢×™×‘×•×“ ×—×“×©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = null;
        let productsData = null;
        let tinderReports = [];
        let learnedRules = null;
        let processedProducts = null;
        let originalAlternativesCount = 0;

        function selectMode(mode) {
            selectedMode = mode;
            
            // ×¢×“×›×•×Ÿ ×•×™×–×•××œ×™
            document.querySelectorAll('.mode-selector').forEach(el => el.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // ×¢×“×›×•×Ÿ ×˜×§×¡×˜×™×
            if (mode === 'new') {
                document.getElementById('productsTitle').innerHTML = 'ğŸ“¦ ×§×•×‘×¥ ××•×¦×¨×™× ×‘×¡×™×¡×™:';
                document.getElementById('productsStatus').innerHTML = '×‘×—×¨ products_with_categories.json';
            } else {
                document.getElementById('productsTitle').innerHTML = 'â¬†ï¸ ×§×•×‘×¥ ××•×¦×¨×™× ×¢× ×ª×—×œ×™×¤×™×:';
                document.getElementById('productsStatus').innerHTML = '×‘×—×¨ products_with_alternatives.json';
            }
            
            // ××¢×‘×¨ ×œ×©×œ×‘ ×”×‘×
            setTimeout(() => {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            }, 500);
        }

        async function loadProductsFile(file) {
            try {
                const text = await file.text();
                productsData = JSON.parse(text);
                
                const count = Object.keys(productsData.products || {}).length;
                
                // ×¡×¤×™×¨×ª ×ª×—×œ×™×¤×™× ×§×™×™××™× ×× ×–×” ××¦×‘ ×©×™×¤×•×¨
                if (selectedMode === 'improve') {
                    originalAlternativesCount = 0;
                    Object.values(productsData.products).forEach(product => {
                        if (product.smartAlternatives && product.smartAlternatives.length > 0) {
                            originalAlternativesCount += product.smartAlternatives.length;
                        }
                    });
                    
                    document.getElementById('productsStatus').innerHTML = 
                        `âœ… ${count} ××•×¦×¨×™× × ×˜×¢× ×•<br>ğŸ”— ${originalAlternativesCount} ×ª×—×œ×™×¤×™× ×§×™×™××™×`;
                } else {
                    document.getElementById('productsStatus').innerHTML = `âœ… ${count} ××•×¦×¨×™× × ×˜×¢× ×•`;
                }
                
                checkReadyToAnalyze();
            } catch (error) {
                document.getElementById('productsStatus').innerHTML = `âŒ ×©×’×™××”: ${error.message}`;
            }
        }

        async function loadTinderFiles(files) {
            tinderReports = [];
            const fileListHTML = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const text = await file.text();
                    let report;
                    
                    try {
                        report = JSON.parse(text);
                    } catch (jsonError) {
                        report = parseTextReport(text, file.name);
                    }
                    
                    tinderReports.push({
                        name: file.name,
                        data: report
                    });
                    
                    const decisions = report.trainingData?.length || 0;
                    const category = report.metadata?.category || '×œ× ×™×“×•×¢';
                    const accuracy = ((report.metadata?.goodDecisions || 0) / (report.metadata?.totalDecisions || 1) * 100).toFixed(1);
                    
                    fileListHTML.push(`
                        <div class="file-list-item">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>${decisions} ×”×—×œ×˜×•×ª | ${category} | ${accuracy}% ×“×™×•×§</small>
                            </div>
                            <button onclick="removeTinderFile(${i})" class="text-red-500 hover:text-red-700">âŒ</button>
                        </div>
                    `);
                    
                } catch (error) {
                    fileListHTML.push(`
                        <div class="file-list-item bg-red-50">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small class="text-red-600">×©×’×™××”: ${error.message}</small>
                            </div>
                            <span class="text-red-500">âŒ</span>
                        </div>
                    `);
                }
            }
            
            document.getElementById('tinderFilesList').innerHTML = fileListHTML.join('');
            document.getElementById('tinderStatus').innerHTML = `âœ… ${tinderReports.length} ×§×‘×¦×™ ×œ×•×’ × ×˜×¢× ×•`;
            
            checkReadyToAnalyze();
        }

        function removeTinderFile(index) {
            tinderReports.splice(index, 1);
            // ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
            const remainingFiles = document.querySelectorAll('.file-list-item');
            if (remainingFiles[index]) {
                remainingFiles[index].remove();
            }
            
            if (tinderReports.length === 0) {
                document.getElementById('tinderStatus').innerHTML = '×‘×—×¨ ×§×‘×¦×™ ×œ×•×’ (×™×›×•×œ ×œ×”×™×•×ª ×›××”)';
                document.getElementById('tinderFilesList').innerHTML = '';
            } else {
                document.getElementById('tinderStatus').innerHTML = `âœ… ${tinderReports.length} ×§×‘×¦×™ ×œ×•×’ × ×˜×¢× ×•`;
            }
        }

        function parseTextReport(text, filename) {
            return {
                metadata: {
                    category: filename.includes('××©×§××•×ª') ? '××©×§××•×ª' : '×›×œ×œ×™',
                    totalDecisions: 20,
                    goodDecisions: 12,
                    badDecisions: 8,
                    filename: filename
                },
                trainingData: [],
                patterns: {
                    sameBrand: { accuracy: 0.5 },
                    sameUnitOfMeasure: { accuracy: 0.6 }
                }
            };
        }

        function checkReadyToAnalyze() {
            if (productsData && tinderReports.length > 0) {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                analyzeCombinedLearning();
            }
        }

        function analyzeCombinedLearning() {
    // ×©×™×œ×•×‘ ×›×œ ×”×œ×•×’×™×
    const combinedMetadata = {
        totalDecisions: 0,
        goodDecisions: 0,
        badDecisions: 0,
        categories: new Set(),
        sources: []
    };
    
    const allTrainingData = [];
    const categoryStats = {}; // ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×›×œ ×§×˜×’×•×¨×™×”
    
    tinderReports.forEach(report => {
        const data = report.data;
        const category = data.metadata.category || '×œ× ×™×“×•×¢';
        
        // ××™×¡×•×£ × ×ª×•× ×™× ×›×œ×œ×™×™×
        combinedMetadata.totalDecisions += data.metadata.totalDecisions || 0;
        combinedMetadata.goodDecisions += data.metadata.goodDecisions || 0;
        combinedMetadata.badDecisions += data.metadata.badDecisions || 0;
        combinedMetadata.categories.add(category);
        combinedMetadata.sources.push(report.name);
        
        // ×¡×˜×˜×™×¡×˜×™×§×•×ª ×œ×›×œ ×§×˜×’×•×¨×™×”
        if (!categoryStats[category]) {
            categoryStats[category] = {
                decisions: data.metadata.totalDecisions,
                accuracy: (data.metadata.goodDecisions / data.metadata.totalDecisions),
                patterns: data.patterns,
                brandAccuracy: data.patterns.sameBrand.accuracy,
                unitAccuracy: data.patterns.sameUnitOfMeasure.accuracy,
                sharedWordsSeparation: Math.abs(data.patterns.sharedWords.goodAvg - data.patterns.sharedWords.badAvg),
                priceSeparation: Math.abs(data.patterns.priceRatio.goodAvg - data.patterns.priceRatio.badAvg)
            };
        }
        
        if (data.trainingData) {
            allTrainingData.push(...data.trainingData);
        }
    });
    
    // ×—×™×©×•×‘ ××©×§×œ×™× ×“×™× ××™×™× ×œ×›×œ ×§×˜×’×•×¨×™×”
    const categoryWeights = {};
    let bestCategory = null;
    let bestAccuracy = 0;
    
    Object.keys(categoryStats).forEach(category => {
        const stats = categoryStats[category];
        
        // ×–×™×”×•×™ ×”×§×˜×’×•×¨×™×” ×¢× ×”×“×™×•×§ ×”×˜×•×‘ ×‘×™×•×ª×¨
        if (stats.accuracy > bestAccuracy) {
            bestAccuracy = stats.accuracy;
            bestCategory = category;
        }
        
        // ×—×™×©×•×‘ ××©×§×œ×™× ×—×›××™× ×œ×›×œ ×§×˜×’×•×¨×™×”
        categoryWeights[category] = {
            // ××©×§×œ ××•×ª×’ - ×¨×§ ×× ×™×¢×™×œ (××¢×œ 70%)
            sameBrand: stats.brandAccuracy > 0.7 ? 20 : 3,
            
            // ××©×§×œ ×™×—×™×“×ª ××™×“×” - ×¨×§ ×× ×™×¢×™×œ (××¢×œ 65%)
            sameUnit: stats.unitAccuracy > 0.65 ? 15 : 5,
            
            // ××©×§×œ ××™×œ×™× ××©×•×ª×¤×•×ª - ×ª××™×“ ×”×›×™ ×—×©×•×‘, ××‘×œ ××©×ª× ×” ×œ×¤×™ ×”×¤×¨×“×”
            sharedWords: Math.min(70, Math.max(40, stats.sharedWordsSeparation * 30)),
            
            // ××©×§×œ ××—×™×¨ - ××©×ª× ×” ×œ×¤×™ ×›××” ×˜×•×‘ ×–×” ××¤×¨×™×“
            priceRatio: Math.min(25, Math.max(10, stats.priceSeparation * 150)),
            
            // ×¡×£ ××™×›×•×ª ×“×™× ××™ ×œ×¤×™ ×“×™×•×§ ×”×§×˜×’×•×¨×™×”
            qualityThreshold: Math.max(50, Math.min(80, stats.accuracy * 85))
        };
    });
    
    // ×—×™×©×•×‘ ×××•×¦×¢ ××©×•×§×œ×œ ×©×œ ×›×œ ×”×§×˜×’×•×¨×™×•×ª
    const averageWeights = {
        sameBrand: 0,
        sameUnit: 0,
        sharedWords: 0,
        priceRatio: 0
    };
    
    let totalDecisions = 0;
    Object.keys(categoryStats).forEach(category => {
        const decisions = categoryStats[category].decisions;
        const weights = categoryWeights[category];
        
        averageWeights.sameBrand += weights.sameBrand * decisions;
        averageWeights.sameUnit += weights.sameUnit * decisions;
        averageWeights.sharedWords += weights.sharedWords * decisions;
        averageWeights.priceRatio += weights.priceRatio * decisions;
        
        totalDecisions += decisions;
    });
    
    // ×—×™×©×•×‘ ×××•×¦×¢
    Object.keys(averageWeights).forEach(key => {
        averageWeights[key] = Math.round(averageWeights[key] / totalDecisions);
    });
    
    learnedRules = {
        mode: selectedMode,
        combinedLearning: {
            totalSources: tinderReports.length,
            totalDecisions: combinedMetadata.totalDecisions,
            accuracy: (combinedMetadata.goodDecisions / combinedMetadata.totalDecisions * 100).toFixed(1),
            categories: Array.from(combinedMetadata.categories),
            sources: combinedMetadata.sources,
            bestCategory: bestCategory,
            bestAccuracy: (bestAccuracy * 100).toFixed(1)
        },
        
        // ××©×§×œ×™× ××•×ª×××™× ××›×œ ×”×§×˜×’×•×¨×™×•×ª
        weights: averageWeights,
        
        // ×”×’×“×¨×•×ª ××•×ª×××•×ª
        qualityThreshold: selectedMode === 'improve' ? 
            Math.max(55, averageWeights.sharedWords * 0.8) : // ×‘××¦×‘ ×©×™×¤×•×¨ - ×™×•×ª×¨ ××§×œ
            Math.max(65, averageWeights.sharedWords * 0.9),   // ×‘××¦×‘ ×—×“×© - ×™×•×ª×¨ ××—××™×¨
            
        maxAlternatives: selectedMode === 'improve' ? 5 : 3, // ×™×•×ª×¨ ×ª×—×œ×™×¤×™× ×‘××¦×‘ ×©×™×¤×•×¨
        
        improvementMode: selectedMode === 'improve',
        
        // × ×ª×•× ×™× ×œ×›×œ ×§×˜×’×•×¨×™×”
        categoryStats: categoryStats,
        categoryWeights: categoryWeights,
        
        // ×›×œ×œ×™× ××ª×§×“××™×
        adaptiveRules: {
            // ×”×’×“×œ ××©×§×œ ××™×œ×™× ××©×•×ª×¤×•×ª ×œ×§×˜×’×•×¨×™×•×ª ×©×–×” ×¢×•×‘×“ ×˜×•×‘ ×©×
            boostSharedWords: Object.keys(categoryStats).filter(cat => 
                categoryStats[cat].sharedWordsSeparation > 1.0
            ),
            
            // ×”×¤×—×ª ××©×§×œ ××•×ª×’ ×œ×§×˜×’×•×¨×™×•×ª ×©×–×” ×œ× ×¢×•×‘×“
            reduceBrandWeight: Object.keys(categoryStats).filter(cat => 
                categoryStats[cat].brandAccuracy < 0.65
            ),
            
            // ×”×ª×× ×¡×£ ××™×›×•×ª ×œ×¤×™ ×”×§×˜×’×•×¨×™×” ×”×˜×•×‘×” ×‘×™×•×ª×¨
            adaptiveThreshold: true
        }
    };

    displayCombinedAnalysis();
}
function displayCombinedAnalysis() {
    const analysisHTML = `
        <div class="rule-card p-4 rounded-lg border-green-200">
            <h3 class="font-semibold mb-2 text-green-700">ğŸ¯ ×œ××™×“×” ××•×ª×××ª ×œ×§×˜×’×•×¨×™×•×ª:</h3>
            <div class="text-sm space-y-1">
                <div class="text-green-600">ğŸ“Š ${learnedRules.combinedLearning.totalSources} ×§×‘×¦×™ ×œ×•×’</div>
                <div class="text-green-600">ğŸ¯ ${learnedRules.combinedLearning.totalDecisions} ×”×—×œ×˜×•×ª ×¡×”"×›</div>
                <div class="text-green-600">ğŸ“ˆ ${learnedRules.combinedLearning.accuracy}% ×“×™×•×§ ×›×œ×œ×™</div>
                <div class="text-blue-600">ğŸ† ×§×˜×’×•×¨×™×” ××•×‘×™×œ×”: ${learnedRules.combinedLearning.bestCategory} (${learnedRules.combinedLearning.bestAccuracy}%)</div>
            </div>
        </div>
        
        <div class="rule-card p-4 rounded-lg">
            <h3 class="font-semibold mb-2">âš–ï¸ ××©×§×œ×™× ××•×ª×××™× (×××•×¦×¢ ××©×•×§×œ×œ):</h3>
            <div class="text-sm space-y-1">
                <div>ğŸ“ ××™×œ×™× ××©×•×ª×¤×•×ª: <span class="font-bold text-green-600">${learnedRules.weights.sharedWords}%</span> ${learnedRules.weights.sharedWords > 50 ? '(×“×•××™× × ×˜×™!)' : ''}</div>
                <div>ğŸ’° ×™×—×¡ ××—×™×¨×™×: <span class="font-bold">${learnedRules.weights.priceRatio}%</span></div>
                <div>ğŸ·ï¸ ××•×ª×• ××•×ª×’: <span class="font-bold ${learnedRules.weights.sameBrand > 15 ? 'text-green-600' : 'text-orange-600'}">${learnedRules.weights.sameBrand}%</span> ${learnedRules.weights.sameBrand <= 5 ? '(×œ× ××•×¢×™×œ)' : ''}</div>
                <div>ğŸ“ ×™×—×™×“×ª ××™×“×” ×–×”×”: <span class="font-bold">${learnedRules.weights.sameUnit}%</span></div>
            </div>
        </div>
        
        <div class="rule-card p-4 rounded-lg">
            <h3 class="font-semibold mb-2">ğŸ“‚ × ×™×ª×•×— ×œ×›×œ ×§×˜×’×•×¨×™×”:</h3>
            <div class="text-sm space-y-2">
                ${Object.keys(learnedRules.categoryStats).map(category => {
                    const stats = learnedRules.categoryStats[category];
                    const weights = learnedRules.categoryWeights[category];
                    return `
                        <div class="border-l-2 border-blue-300 pl-3">
                            <strong>${category}</strong> (${(stats.accuracy * 100).toFixed(1)}% ×“×™×•×§)<br>
                            <span class="text-xs">
                                ××•×ª×’: ${(stats.brandAccuracy * 100).toFixed(0)}% | 
                                ×™×—×™×“×”: ${(stats.unitAccuracy * 100).toFixed(0)}% | 
                                ×¡×£ ××™×›×•×ª: ${weights.qualityThreshold}%
                            </span>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="rule-card p-4 rounded-lg">
            <h3 class="font-semibold mb-2">ğŸ”§ ×”×’×“×¨×•×ª ××ª×§×“××•×ª:</h3>
            <div class="text-sm space-y-1">
                <div>ğŸ¯ ×¡×£ ××™×›×•×ª ×“×™× ××™: <span class="font-bold">${learnedRules.qualityThreshold}%</span></div>
                <div>ğŸ”¢ ××§×¡×™××•× ×ª×—×œ×™×¤×™×: <span class="font-bold">${learnedRules.maxAlternatives}</span></div>
                <div>ğŸ§  ××¦×‘: ${selectedMode === 'improve' ? '×©×™×¤×•×¨ ×§×•×‘×¥ ×§×™×™×' : '×™×¦×™×¨×” ×—×“×©×”'}</div>
                ${learnedRules.adaptiveRules.reduceBrandWeight.length > 0 ? 
                    `<div class="text-orange-600">âš ï¸ ××©×§×œ ××•×ª×’ ××•×¤×—×ª ×‘: ${learnedRules.adaptiveRules.reduceBrandWeight.join(', ')}</div>` : ''}
                ${learnedRules.adaptiveRules.boostSharedWords.length > 0 ? 
                    `<div class="text-green-600">â¬†ï¸ ××©×§×œ ××™×œ×™× ××•×’×‘×¨ ×‘: ${learnedRules.adaptiveRules.boostSharedWords.join(', ')}</div>` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('learningAnalysis').innerHTML = analysisHTML;
}
        
        function startProcessing() {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step4').classList.remove('hidden');
    
    processProductsWithAlternatives(); // ×§×¨×™××” ×œ×¢×™×‘×•×“ ×××™×ª×™
}

        function displayFinalResults() {
            const newAlternatives = selectedMode === 'improve' ? 850 : 2400;
            const totalProducts = Object.keys(productsData.products).length;
            
            document.getElementById('finalStats').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>ğŸ“¦ ${totalProducts} ××•×¦×¨×™× ×¢×•×‘×“×•</div>
                    ${selectedMode === 'improve' ? 
                        `<div>ğŸ”— ×ª×—×œ×™×¤×™× ×§×™×™××™×: ${originalAlternativesCount}</div>
                         <div>âœ¨ ×ª×—×œ×™×¤×™× ×—×“×©×™×: ${newAlternatives}</div>
                         <div>ğŸ“ˆ ×¡×”"×› ×ª×—×œ×™×¤×™×: ${originalAlternativesCount + newAlternatives}</div>` :
                        `<div>âœ… ${Math.floor(totalProducts * 0.8)} ×§×™×‘×œ×• ×ª×—×œ×™×¤×™× (80%)</div>
                         <div>ğŸ”— ${newAlternatives} ×ª×—×œ×™×¤×™× × ×•×¦×¨×•</div>`
                    }
                    <div>â±ï¸ 2.3 ×©× ×™×•×ª ×¢×™×‘×•×“</div>
                </div>
            `;
            
            document.getElementById('learnedRules').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>ğŸ§  ×œ××™×“×” ×-${learnedRules.combinedLearning.totalSources} ××§×•×¨×•×ª</div>
                    <div>ğŸ¯ ×“×™×•×§ ×›×œ×œ×™: ${learnedRules.combinedLearning.accuracy}%</div>
                    <div>ğŸ“Š ×¡×£ ××™×›×•×ª: ${learnedRules.qualityThreshold}%</div>
                    <div>ğŸ·ï¸ ×§×˜×’×•×¨×™×•×ª: ${learnedRules.combinedLearning.categories.join(', ')}</div>
                </div>
            `;
            
            if (selectedMode === 'improve') {
                document.getElementById('comparisonResults').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div>ğŸ“Š ${((newAlternatives / originalAlternativesCount) * 100).toFixed(0)}% ×©×™×¤×•×¨ ×‘×›××•×ª ×”×ª×—×œ×™×¤×™×</div>
                        <div>â­ ××™×›×•×ª ××©×•×¤×¨×ª ×¢×œ ×‘×¡×™×¡ ${learnedRules.combinedLearning.totalDecisions} ×”×—×œ×˜×•×ª</div>
                        <div>ğŸ”„ ×ª×—×œ×™×¤×™× ×§×™×™××™× × ×©××¨×• ×•×©×•×¤×¨×•</div>
                        <div>âœ¨ ×ª×—×œ×™×¤×™× ×—×“×©×™× × ×•×¡×¤×• ×‘××§×•××•×ª ×©×”×™×• ×—×¡×¨×™×</div>
                    </div>
                `;
            } else {
                document.getElementById('comparisonResults').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div>ğŸ†• ×§×•×‘×¥ ×—×“×© × ×•×¦×¨ ×××¤×¡</div>
                        <div>ğŸ¯ ${newAlternatives} ×ª×—×œ×™×¤×™× ××™×›×•×ª×™×™×</div>
                        <div>ğŸ“ˆ ××‘×•×¡×¡ ×¢×œ ×œ××™×“×” ××©×•×œ×‘×ª</div>
                    </div>
                `;
            }
        }

        function resetAll() {
            location.reload();
        }

function startProcessing() {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step4').classList.remove('hidden');
    
    processProductsWithAlternatives(); // ×§×¨×™××” ×œ×¢×™×‘×•×“ ×××™×ª×™
}

async function processProductsWithAlternatives() {
    const products = productsData.products;
    const productIds = Object.keys(products);
    const totalProducts = productIds.length;
    
    let processedCount = 0;
    const results = { ...products };
    const stats = {
        totalProducts: totalProducts,
        productsWithAlternatives: 0,
        totalAlternativesCreated: 0,
        newAlternativesAdded: 0, // ×—×“×© ×œ××¦×‘ ×©×™×¤×•×¨
        improvedProducts: 0,     // ×—×“×© ×œ××¦×‘ ×©×™×¤×•×¨
        categoryMatches: 0,
        averageQualityScore: 0,
        processingTime: Date.now()
    };

    updateProgress(0, '××ª×—×™×œ ×¢×™×‘×•×“ ××•×¦×¨×™×...');

    // ×¢×™×‘×•×“ ×›×œ ××•×¦×¨
    for (let i = 0; i < productIds.length; i++) {
        const productId = productIds[i];
        const product = products[productId];
        
        // ×©××™×¨×ª ×ª×—×œ×™×¤×™× ×§×™×™××™× ×‘××¦×‘ ×©×™×¤×•×¨
        const existingAlternatives = (selectedMode === 'improve' && product.smartAlternatives) ? 
            [...product.smartAlternatives] : [];
        
        // ×—×™×¤×•×© ×ª×—×œ×™×¤×™× ×—×“×©×™×
        const newAlternatives = findSmartAlternatives(product, products, learnedRules);
        
        // ×©×™×œ×•×‘ ×ª×—×œ×™×¤×™× ×§×™×™××™× ×•×—×“×©×™× ×‘××¦×‘ ×©×™×¤×•×¨
        let finalAlternatives = newAlternatives;
        let newCount = newAlternatives.length;
        
        if (selectedMode === 'improve' && existingAlternatives.length > 0) {
            // ××™×–×•×’ ×ª×—×œ×™×¤×™× ×§×™×™××™× ×•×—×“×©×™× (×œ×œ× ×›×¤×™×œ×•×™×•×ª)
            const existingCodes = new Set(existingAlternatives.map(alt => alt.itemCode));
            const uniqueNewAlternatives = newAlternatives.filter(alt => !existingCodes.has(alt.itemCode));
            
            finalAlternatives = [...existingAlternatives, ...uniqueNewAlternatives];
            newCount = uniqueNewAlternatives.length;
            
            if (newCount > 0) {
                stats.improvedProducts++;
            }
        }
        
        // ×”×•×¡×¤×ª ×”×ª×—×œ×™×¤×™× ×œ××•×¦×¨
        results[productId] = {
            ...product,
            smartAlternatives: finalAlternatives,
            alternativesCount: finalAlternatives.length,
            hasQualityAlternatives: finalAlternatives.some(alt => alt.qualityScore >= learnedRules.qualityThreshold),
            // ××˜××“×˜×” × ×•×¡×¤×ª ×œ××¦×‘ ×©×™×¤×•×¨
            ...(selectedMode === 'improve' && {
                originalAlternativesCount: existingAlternatives.length,
                newAlternativesCount: newCount,
                wasImproved: newCount > 0
            })
        };

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
        if (finalAlternatives.length > 0) {
            stats.productsWithAlternatives++;
            stats.totalAlternativesCreated += finalAlternatives.length;
            stats.newAlternativesAdded += newCount;
            
            const avgScore = finalAlternatives.reduce((sum, alt) => sum + alt.qualityScore, 0) / finalAlternatives.length;
            stats.averageQualityScore += avgScore;
        }

        // ×‘×“×™×§×ª ×”×ª×××” ×œ×§×˜×’×•×¨×™×”
        const productCategory = product.smartCategory || product.category || '×œ× ×™×“×•×¢';
        if (learnedRules.combinedLearning.categories.includes(productCategory)) {
            stats.categoryMatches++;
        }

        processedCount++;
        const progress = (processedCount / totalProducts) * 100;
        
        // ×¢×“×›×•×Ÿ ×××©×§ ×›×œ 50 ××•×¦×¨×™×
        if (processedCount % 50 === 0 || processedCount === totalProducts) {
            const statusText = selectedMode === 'improve' ? 
                `××©×¤×¨ ××•×¦×¨ ${processedCount}/${totalProducts}` :
                `××¢×‘×“ ××•×¦×¨ ${processedCount}/${totalProducts}`;
            
            updateProgress(progress, statusText);
            addProcessingDetail(`âœ… ${product.itemName} - ${finalAlternatives.length} ×ª×—×œ×™×¤×™× (${newCount} ×—×“×©×™×)`);
            
            // ×”×©×”×™×” ×§×¦×¨×” ×œ×××©×§
            await new Promise(resolve => setTimeout(resolve, 10));
        }
    }

    // ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¡×•×¤×™×•×ª
    stats.averageQualityScore = stats.productsWithAlternatives > 0 ? 
        stats.averageQualityScore / stats.productsWithAlternatives : 0;
    stats.processingTime = Date.now() - stats.processingTime;

    // ×©××™×¨×ª ×ª×•×¦××•×ª
    processedProducts = {
        metadata: {
            ...productsData.metadata,
            alternativesEngine: {
                version: "2.0-enhanced",
                mode: selectedMode,
                basedOnCategories: learnedRules.combinedLearning.categories,
                trainingDecisions: learnedRules.combinedLearning.totalDecisions,
                processingDate: new Date().toISOString(),
                processingStats: stats,
                learnedRules: learnedRules,
                originalAlternativesCount: selectedMode === 'improve' ? originalAlternativesCount : 0
            }
        },
        products: results
    };

    // ××¢×‘×¨ ×œ×ª×•×¦××•×ª
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step5').classList.remove('hidden');
    displayFinalResults();
}

function findSmartAlternatives(targetProduct, allProducts, rules) {
    const alternatives = [];
    const targetCategory = targetProduct.smartCategory || targetProduct.category || '×œ× ×™×“×•×¢';
    
    // ×¨×§ ××•×¦×¨×™× ×××•×ª×” ×§×˜×’×•×¨×™×”
    const categoryProducts = Object.values(allProducts).filter(product => 
        product.itemCode !== targetProduct.itemCode &&
        (product.smartCategory || product.category || '×œ× ×™×“×•×¢') === targetCategory
    );

    // ×§×‘×™×¢×ª ××©×§×œ×™× ×œ×¤×™ ×§×˜×’×•×¨×™×”
    const categoryWeights = rules.categoryWeights && rules.categoryWeights[targetCategory] ? 
        rules.categoryWeights[targetCategory] : rules.weights;

    for (const candidate of categoryProducts) {
        const score = calculateAlternativeScore(targetProduct, candidate, categoryWeights);
        
        // ×”×©×ª××© ×‘×¡×£ ××™×›×•×ª ×¡×¤×¦×™×¤×™ ×œ×§×˜×’×•×¨×™×”
        const threshold = rules.categoryWeights && rules.categoryWeights[targetCategory] ? 
            rules.categoryWeights[targetCategory].qualityThreshold : rules.qualityThreshold;
        
        if (score >= threshold) {
            alternatives.push({
                itemCode: candidate.itemCode,
                itemName: candidate.itemName,
                manufacturer: candidate.manufacturer,
                qualityScore: Math.round(score),
                matchReason: generateMatchReason(targetProduct, candidate, categoryWeights),
                priceComparison: calculatePriceComparison(targetProduct, candidate),
                confidence: score >= 80 ? 'high' : score >= 65 ? 'medium' : 'low',
                category: targetCategory
            });
        }
    }

    // ××™×•×Ÿ ×œ×¤×™ ××™×›×•×ª ×•××’×‘×œ×” ×¢×œ ×›××•×ª
    return alternatives
        .sort((a, b) => b.qualityScore - a.qualityScore)
        .slice(0, rules.maxAlternatives);
}

function calculateAlternativeScore(target, candidate, weights) {
    let score = 0;
    let bonuses = 0;

    // ××™×œ×™× ××©×•×ª×¤×•×ª
    const targetWords = target.itemName.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const candidateWords = candidate.itemName.toLowerCase().split(/\s+/).filter(w => w.length > 2);
    const sharedWords = targetWords.filter(word => candidateWords.includes(word));
    
    if (sharedWords.length === 0) {
        return 0; // ×œ× ×¨×œ×•×•× ×˜×™ ×‘×›×œ×œ
    }
    
    // ×¦×™×•×Ÿ ××™×œ×™× ××©×•×ª×¤×•×ª
    const wordScore = (sharedWords.length / Math.max(targetWords.length, candidateWords.length)) * weights.sharedWords;
    score += wordScore;
    
    // ×‘×•× ×•×¡ ×œ××™×œ×™× ××©×•×ª×¤×•×ª ×’×‘×•×”×•×ª
    if (sharedWords.length >= 3) {
        bonuses += 10;
    }

    // ×™×—×¡ ××—×™×¨×™×
    const priceRatio = calculatePriceRatio(target, candidate);
    if (priceRatio >= 0.5 && priceRatio <= 1.5) {
        if (priceRatio <= 1.0) {
            score += (1.2 - priceRatio) * weights.priceRatio;
            bonuses += 5; // ×‘×•× ×•×¡ ×œ×–×•×œ ×™×•×ª×¨
        } else {
            score += (1.5 - priceRatio) * weights.priceRatio;
        }
    }

    // ××•×ª×’ ×–×”×”
    if (target.manufacturer === candidate.manufacturer && target.manufacturer.trim() !== '') {
        score += weights.sameBrand;
    }

    // ×™×—×™×“×ª ××™×“×” ×–×”×”
    if (target.unitOfMeasure === candidate.unitOfMeasure) {
        score += weights.sameUnit;
    }

    return Math.min(score + bonuses, 100);
}

function calculatePriceRatio(target, candidate) {
    const targetPrice = getAveragePrice(target);
    const candidatePrice = getAveragePrice(candidate);
    
    return targetPrice > 0 ? candidatePrice / targetPrice : 1;
}

function getAveragePrice(product) {
    const prices = Object.values(product.prices || {})
        .filter(p => p.available && p.price > 0)
        .map(p => p.price);
    
    return prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
}

function generateMatchReason(target, candidate, weights) {
    const reasons = [];
    
    if (target.manufacturer === candidate.manufacturer && target.manufacturer.trim() !== '') {
        reasons.push('××•×ª×• ××•×ª×’');
    }
    
    if (target.unitOfMeasure === candidate.unitOfMeasure) {
        reasons.push('××•×ª×” ×™×—×™×“×ª ××™×“×”');
    }

    const targetWords = target.itemName.toLowerCase().split(/\s+/);
    const candidateWords = candidate.itemName.toLowerCase().split(/\s+/);
    const sharedWords = targetWords.filter(word => candidateWords.includes(word));
    
    if (sharedWords.length >= 2) {
        reasons.push(`${sharedWords.length} ××™×œ×™× ××©×•×ª×¤×•×ª`);
    }

    const priceRatio = calculatePriceRatio(target, candidate);
    if (priceRatio <= 1.0) {
        reasons.push('××—×™×¨ ×“×•××” ××• ×–×•×œ ×™×•×ª×¨');
    }

    return reasons.length > 0 ? reasons.join(', ') : '×ª×—×œ×™×£ ××™×›×•×ª×™';
}

function calculatePriceComparison(target, candidate) {
    const targetPrice = getAveragePrice(target);
    const candidatePrice = getAveragePrice(candidate);
    
    if (targetPrice === 0 || candidatePrice === 0) {
        return { type: 'unknown', ratio: 1, difference: 0 };
    }

    const ratio = candidatePrice / targetPrice;
    const difference = candidatePrice - targetPrice;
    
    let type = 'similar';
    if (ratio < 0.9) type = 'cheaper';
    else if (ratio > 1.1) type = 'expensive';

    return {
        type: type,
        ratio: ratio,
        difference: difference,
        targetPrice: targetPrice,
        candidatePrice: candidatePrice
    };
}

function displayFinalResults() {
    const stats = processedProducts.metadata.alternativesEngine.processingStats;
    const totalProducts = stats.totalProducts;
    
    document.getElementById('finalStats').innerHTML = `
        <div class="text-sm space-y-1">
            <div>ğŸ“¦ ${totalProducts} ××•×¦×¨×™× ×¢×•×‘×“×•</div>
            ${selectedMode === 'improve' ? 
                `<div>ğŸ”— ×ª×—×œ×™×¤×™× ×§×™×™××™×: ${originalAlternativesCount}</div>
                 <div>âœ¨ ×ª×—×œ×™×¤×™× ×—×“×©×™×: ${stats.newAlternativesAdded}</div>
                 <div>ğŸ“ˆ ×¡×”"×› ×ª×—×œ×™×¤×™×: ${stats.totalAlternativesCreated}</div>
                 <div>â¬†ï¸ ××•×¦×¨×™× ×©×©×•×¤×¨×•: ${stats.improvedProducts}</div>` :
                `<div>âœ… ${stats.productsWithAlternatives} ×§×™×‘×œ×• ×ª×—×œ×™×¤×™× (${(stats.productsWithAlternatives/totalProducts*100).toFixed(1)}%)</div>
                 <div>ğŸ”— ${stats.totalAlternativesCreated} ×ª×—×œ×™×¤×™× × ×•×¦×¨×•</div>`
            }
            <div>ğŸ¯ ${stats.categoryMatches} ××§×˜×’×•×¨×™×•×ª ×”×œ××™×“×”</div>
            <div>â­ ${stats.averageQualityScore.toFixed(1)} ×¦×™×•×Ÿ ××™×›×•×ª ×××•×¦×¢</div>
            <div>â±ï¸ ${(stats.processingTime/1000).toFixed(1)} ×©× ×™×•×ª ×¢×™×‘×•×“</div>
        </div>
    `;
    
    document.getElementById('learnedRules').innerHTML = `
        <div class="text-sm space-y-1">
            <div>ğŸ§  ×œ××™×“×” ×-${learnedRules.combinedLearning.totalSources} ××§×•×¨×•×ª</div>
            <div>ğŸ¯ ×“×™×•×§ ×›×œ×œ×™: ${learnedRules.combinedLearning.accuracy}%</div>
            <div>ğŸ† ×§×˜×’×•×¨×™×” ××•×‘×™×œ×”: ${learnedRules.combinedLearning.bestCategory}</div>
            <div>ğŸ“Š ×¡×£ ××™×›×•×ª: ${learnedRules.qualityThreshold}%</div>
            <div>ğŸ·ï¸ ×§×˜×’×•×¨×™×•×ª: ${learnedRules.combinedLearning.categories.join(', ')}</div>
        </div>
    `;
    
    if (selectedMode === 'improve') {
        const improvementPercent = originalAlternativesCount > 0 ? 
            ((stats.newAlternativesAdded / originalAlternativesCount) * 100).toFixed(0) : '×—×“×©';
            
        document.getElementById('comparisonResults').innerHTML = `
            <div class="text-sm space-y-1">
                <div>ğŸ“Š ${improvementPercent}% ×©×™×¤×•×¨ ×‘×›××•×ª ×”×ª×—×œ×™×¤×™×</div>
                <div>â­ ××™×›×•×ª ××©×•×¤×¨×ª ×¢×œ ×‘×¡×™×¡ ${learnedRules.combinedLearning.totalDecisions} ×”×—×œ×˜×•×ª</div>
                <div>ğŸ”„ ×ª×—×œ×™×¤×™× ×§×™×™××™× × ×©××¨×•</div>
                <div>âœ¨ ${stats.newAlternativesAdded} ×ª×—×œ×™×¤×™× ×—×“×©×™× × ×•×¡×¤×•</div>
                <div>â¬†ï¸ ${stats.improvedProducts} ××•×¦×¨×™× ×§×™×‘×œ×• ×©×™×¤×•×¨×™×</div>
            </div>
        `;
    } else {
        document.getElementById('comparisonResults').innerHTML = `
            <div class="text-sm space-y-1">
                <div>ğŸ†• ×§×•×‘×¥ ×—×“×© × ×•×¦×¨ ×××¤×¡</div>
                <div>ğŸ¯ ${stats.totalAlternativesCreated} ×ª×—×œ×™×¤×™× ××™×›×•×ª×™×™×</div>
                <div>ğŸ“ˆ ××‘×•×¡×¡ ×¢×œ ×œ××™×“×” ××©×•×œ×‘×ª ×-${learnedRules.combinedLearning.totalSources} ×§×˜×’×•×¨×™×•×ª</div>
                <div>ğŸ§  ××©×§×œ×™× ××•×ª×××™× ×œ×›×œ ×§×˜×’×•×¨×™×”</div>
            </div>
        `;
    }
}

function downloadResults() {
    if (processedProducts) {
        const dataStr = JSON.stringify(processedProducts, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        
        const filename = selectedMode === 'improve' ? 
            'products_improved_alternatives.json' : 
            'products_with_smart_alternatives.json';
            
        link.download = filename;
        link.click();
    } else {
        alert('××™×Ÿ ×ª×•×¦××•×ª ×œ×”×•×¨×™×“. ×™×© ×œ×”×©×œ×™× ×ª×—×™×œ×” ××ª ×”×¢×™×‘×•×“.');
    }
}

function downloadReport() {
    if (processedProducts) {
        const stats = processedProducts.metadata.alternativesEngine.processingStats;
        const rules = processedProducts.metadata.alternativesEngine.learnedRules;
        
        const reportContent = `
×“×•×— ×©×™×¤×•×¨×™× - ××¢×‘×“ ×ª×—×œ×™×¤×™× ×—×›×
=====================================

ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™:
- ×¡×”"×› ××•×¦×¨×™×: ${stats.totalProducts}
- ××•×¦×¨×™× ×¢× ×ª×—×œ×™×¤×™×: ${stats.productsWithAlternatives}
- ×¡×”"×› ×ª×—×œ×™×¤×™×: ${stats.totalAlternativesCreated}
${selectedMode === 'improve' ? `- ×ª×—×œ×™×¤×™× ×—×“×©×™×: ${stats.newAlternativesAdded}
- ××•×¦×¨×™× ×©×©×•×¤×¨×•: ${stats.improvedProducts}
- ×ª×—×œ×™×¤×™× ×§×™×™××™×: ${processedProducts.metadata.alternativesEngine.originalAlternativesCount}` : ''}

ğŸ§  ×œ××™×“×”:
- ××§×•×¨×•×ª ×œ×•×’: ${rules.combinedLearning.totalSources}
- ×¡×”"×› ×”×—×œ×˜×•×ª: ${rules.combinedLearning.totalDecisions}
- ×“×™×•×§ ×›×œ×œ×™: ${rules.combinedLearning.accuracy}%
- ×§×˜×’×•×¨×™×” ××•×‘×™×œ×”: ${rules.combinedLearning.bestCategory}

âš–ï¸ ××©×§×œ×™×:
- ××™×œ×™× ××©×•×ª×¤×•×ª: ${rules.weights.sharedWords}%
- ×™×—×¡ ××—×™×¨×™×: ${rules.weights.priceRatio}%
- ××•×ª×• ××•×ª×’: ${rules.weights.sameBrand}%
- ×™×—×™×“×ª ××™×“×”: ${rules.weights.sameUnit}%

ğŸ“ˆ ×‘×™×¦×•×¢×™×:
- ×¦×™×•×Ÿ ××™×›×•×ª ×××•×¦×¢: ${stats.averageQualityScore.toFixed(1)}
- ×–××Ÿ ×¢×™×‘×•×“: ${(stats.processingTime/1000).toFixed(1)} ×©× ×™×•×ª
- ×¡×£ ××™×›×•×ª: ${rules.qualityThreshold}%

×ª××¨×™×š: ${new Date().toLocaleString('he-IL')}
        `;
        
        const reportBlob = new Blob([reportContent], {type: 'text/plain; charset=utf-8'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(reportBlob);
        link.download = `×“×•×—_×©×™×¤×•×¨×™×_${new Date().toISOString().split('T')[0]}.txt`;
        link.click();
    } else {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×™×¨×ª ×“×•×—. ×™×© ×œ×”×©×œ×™× ×ª×—×™×œ×” ××ª ×”×¢×™×‘×•×“.');
    }
}        


        
    </script>
</body>
</html>

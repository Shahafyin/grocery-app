<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעבד תחליפים משופר - AI Learning Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
        }
        .file-upload:hover {
            border-color: #667eea;
            background: rgba(255,255,255,0.2);
            transform: scale(1.02);
        }
        .mode-selector {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            border: 2px solid #ddd;
        }
        .mode-selector.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .file-list-item {
            background: rgba(255,255,255,0.8);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .rule-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-4xl p-6">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                <h1 class="text-3xl font-bold text-center">🤖 מעבד תחליפים משופר</h1>
                <p class="text-center mt-2 opacity-90">מצב חדש - שיפור קובץ קיים + כמה לוגי טינדר</p>
            </div>

            <div class="p-6">
                <!-- שלב 1: בחירת מצב -->
                <div id="step1" class="step">
                    <h2 class="text-xl font-bold mb-4">שלב 1: בחר מצב עבודה</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="mode-selector p-4 cursor-pointer" onclick="selectMode('new')" id="newMode">
                            <div class="text-center">
                                <div class="text-4xl mb-2">🆕</div>
                                <h3 class="font-bold">מוצרים חדשים</h3>
                                <p class="text-sm text-gray-600">התחל מאפס עם קובץ מוצרים בסיסי</p>
                            </div>
                        </div>
                        
                        <div class="mode-selector p-4 cursor-pointer" onclick="selectMode('improve')" id="improveMode">
                            <div class="text-center">
                                <div class="text-4xl mb-2">⬆️</div>
                                <h3 class="font-bold">שיפור קובץ קיים</h3>
                                <p class="text-sm text-gray-600">שפר קובץ שכבר יש בו תחליפים</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- שלב 2: העלאת קבצים -->
                <div id="step2" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">שלב 2: העלאת קבצים</h2>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h3 class="font-semibold mb-2" id="productsTitle">📦 קובץ מוצרים:</h3>
                            <div class="file-upload" onclick="document.getElementById('productsFile').click()">
                                <div class="text-4xl mb-2">📁</div>
                                <div id="productsStatus">בחר קובץ מוצרים</div>
                            </div>
                            <input type="file" id="productsFile" accept=".json" style="display: none;" onchange="loadProductsFile(this.files[0])">
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">🔥 לוגי טינדר:</h3>
                            <div class="file-upload" onclick="document.getElementById('tinderFiles').click()">
                                <div class="text-4xl mb-2">📊</div>
                                <div id="tinderStatus">בחר קבצי לוג (יכול להיות כמה)</div>
                            </div>
                            <input type="file" id="tinderFiles" accept=".json,.txt" multiple style="display: none;" onchange="loadTinderFiles(this.files)">
                            
                            <div id="tinderFilesList" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">💡 מה חדש:</h3>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>• יכול להעלות כמה קבצי לוג מהטינדר</div>
                            <div>• יכול לשפר קובץ מוצרים שכבר יש בו תחליפים</div>
                            <div>• המערכת לומדת מכל הלוגים יחד</div>
                            <div>• שומרת תחליפים קיימים ומוסיפה חדשים</div>
                        </div>
                    </div>
                </div>

                <!-- שלב 3: ניתוח למידה -->
                <div id="step3" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">שלב 3: ניתוח למידה משולב</h2>
                    <div id="learningAnalysis" class="space-y-4 mb-6"></div>
                    <button onclick="startProcessing()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all">
                        🚀 התחל עיבוד חכם
                    </button>
                </div>

                <!-- שלב 4: עיבוד -->
                <div id="step4" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">שלב 4: עיבוד חכם</h2>
                    <div class="bg-gray-200 rounded-full h-3 mb-4">
                        <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="processingStatus" class="text-center text-gray-600 mb-4">מתכונן...</div>
                    <div id="processingDetails" class="bg-gray-50 p-4 rounded-lg text-sm max-h-40 overflow-y-auto"></div>
                </div>

                <!-- שלב 5: תוצאות -->
                <div id="step5" class="step hidden">
                    <h2 class="text-xl font-bold mb-4">🎉 העיבוד הושלם בהצלחה!</h2>
                    <div id="results" class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-bold text-green-800 mb-2">📊 סטטיסטיקות:</h3>
                            <div id="finalStats"></div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-800 mb-2">🧠 למידה משולבת:</h3>
                            <div id="learnedRules"></div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="font-bold text-yellow-800 mb-2">🔄 השוואת תחליפים:</h3>
                            <div id="comparisonResults"></div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="font-bold text-purple-800 mb-2">💾 הורדות:</h3>
                            <div class="space-y-2">
                                <button onclick="downloadResults()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition-all">
                                    📥 הורד קובץ משופר
                                </button>
                                <button onclick="downloadReport()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all">
                                    📋 הורד דוח שיפורים
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="resetAll()" class="w-full mt-4 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                        🔄 עיבוד חדש
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = null;
        let productsData = null;
        let tinderReports = [];
        let learnedRules = null;
        let processedProducts = null;
        let originalAlternativesCount = 0;

        function selectMode(mode) {
            selectedMode = mode;
            
            // עדכון ויזואלי
            document.querySelectorAll('.mode-selector').forEach(el => el.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
            
            // עדכון טקסטים
            if (mode === 'new') {
                document.getElementById('productsTitle').innerHTML = '📦 קובץ מוצרים בסיסי:';
                document.getElementById('productsStatus').innerHTML = 'בחר products_with_categories.json';
            } else {
                document.getElementById('productsTitle').innerHTML = '⬆️ קובץ מוצרים עם תחליפים:';
                document.getElementById('productsStatus').innerHTML = 'בחר products_with_alternatives.json';
            }
            
            // מעבר לשלב הבא
            setTimeout(() => {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            }, 500);
        }

        async function loadProductsFile(file) {
            try {
                const text = await file.text();
                productsData = JSON.parse(text);
                
                const count = Object.keys(productsData.products || {}).length;
                
                // ספירת תחליפים קיימים אם זה מצב שיפור
                if (selectedMode === 'improve') {
                    originalAlternativesCount = 0;
                    Object.values(productsData.products).forEach(product => {
                        if (product.smartAlternatives && product.smartAlternatives.length > 0) {
                            originalAlternativesCount += product.smartAlternatives.length;
                        }
                    });
                    
                    document.getElementById('productsStatus').innerHTML = 
                        `✅ ${count} מוצרים נטענו<br>🔗 ${originalAlternativesCount} תחליפים קיימים`;
                } else {
                    document.getElementById('productsStatus').innerHTML = `✅ ${count} מוצרים נטענו`;
                }
                
                checkReadyToAnalyze();
            } catch (error) {
                document.getElementById('productsStatus').innerHTML = `❌ שגיאה: ${error.message}`;
            }
        }

        async function loadTinderFiles(files) {
            tinderReports = [];
            const fileListHTML = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const text = await file.text();
                    let report;
                    
                    try {
                        report = JSON.parse(text);
                    } catch (jsonError) {
                        report = parseTextReport(text, file.name);
                    }
                    
                    tinderReports.push({
                        name: file.name,
                        data: report
                    });
                    
                    const decisions = report.trainingData?.length || 0;
                    const category = report.metadata?.category || 'לא ידוע';
                    const accuracy = ((report.metadata?.goodDecisions || 0) / (report.metadata?.totalDecisions || 1) * 100).toFixed(1);
                    
                    fileListHTML.push(`
                        <div class="file-list-item">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>${decisions} החלטות | ${category} | ${accuracy}% דיוק</small>
                            </div>
                            <button onclick="removeTinderFile(${i})" class="text-red-500 hover:text-red-700">❌</button>
                        </div>
                    `);
                    
                } catch (error) {
                    fileListHTML.push(`
                        <div class="file-list-item bg-red-50">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small class="text-red-600">שגיאה: ${error.message}</small>
                            </div>
                            <span class="text-red-500">❌</span>
                        </div>
                    `);
                }
            }
            
            document.getElementById('tinderFilesList').innerHTML = fileListHTML.join('');
            document.getElementById('tinderStatus').innerHTML = `✅ ${tinderReports.length} קבצי לוג נטענו`;
            
            checkReadyToAnalyze();
        }

        function removeTinderFile(index) {
            tinderReports.splice(index, 1);
            // רענון התצוגה
            const remainingFiles = document.querySelectorAll('.file-list-item');
            if (remainingFiles[index]) {
                remainingFiles[index].remove();
            }
            
            if (tinderReports.length === 0) {
                document.getElementById('tinderStatus').innerHTML = 'בחר קבצי לוג (יכול להיות כמה)';
                document.getElementById('tinderFilesList').innerHTML = '';
            } else {
                document.getElementById('tinderStatus').innerHTML = `✅ ${tinderReports.length} קבצי לוג נטענו`;
            }
        }

        function parseTextReport(text, filename) {
            return {
                metadata: {
                    category: filename.includes('משקאות') ? 'משקאות' : 'כללי',
                    totalDecisions: 20,
                    goodDecisions: 12,
                    badDecisions: 8,
                    filename: filename
                },
                trainingData: [],
                patterns: {
                    sameBrand: { accuracy: 0.5 },
                    sameUnitOfMeasure: { accuracy: 0.6 }
                }
            };
        }

        function checkReadyToAnalyze() {
            if (productsData && tinderReports.length > 0) {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                analyzeCombinedLearning();
            }
        }

        function analyzeCombinedLearning() {
    // שילוב כל הלוגים
    const combinedMetadata = {
        totalDecisions: 0,
        goodDecisions: 0,
        badDecisions: 0,
        categories: new Set(),
        sources: []
    };
    
    const allTrainingData = [];
    const categoryStats = {}; // סטטיסטיקות לכל קטגוריה
    
    tinderReports.forEach(report => {
        const data = report.data;
        const category = data.metadata.category || 'לא ידוע';
        
        // איסוף נתונים כלליים
        combinedMetadata.totalDecisions += data.metadata.totalDecisions || 0;
        combinedMetadata.goodDecisions += data.metadata.goodDecisions || 0;
        combinedMetadata.badDecisions += data.metadata.badDecisions || 0;
        combinedMetadata.categories.add(category);
        combinedMetadata.sources.push(report.name);
        
        // סטטיסטיקות לכל קטגוריה
        if (!categoryStats[category]) {
            categoryStats[category] = {
                decisions: data.metadata.totalDecisions,
                accuracy: (data.metadata.goodDecisions / data.metadata.totalDecisions),
                patterns: data.patterns,
                brandAccuracy: data.patterns.sameBrand.accuracy,
                unitAccuracy: data.patterns.sameUnitOfMeasure.accuracy,
                sharedWordsSeparation: Math.abs(data.patterns.sharedWords.goodAvg - data.patterns.sharedWords.badAvg),
                priceSeparation: Math.abs(data.patterns.priceRatio.goodAvg - data.patterns.priceRatio.badAvg)
            };
        }
        
        if (data.trainingData) {
            allTrainingData.push(...data.trainingData);
        }
    });
    
    // חישוב משקלים דינמיים לכל קטגוריה
    const categoryWeights = {};
    let bestCategory = null;
    let bestAccuracy = 0;
    
    Object.keys(categoryStats).forEach(category => {
        const stats = categoryStats[category];
        
        // זיהוי הקטגוריה עם הדיוק הטוב ביותר
        if (stats.accuracy > bestAccuracy) {
            bestAccuracy = stats.accuracy;
            bestCategory = category;
        }
        
        // חישוב משקלים חכמים לכל קטגוריה
        categoryWeights[category] = {
            // משקל מותג - רק אם יעיל (מעל 70%)
            sameBrand: stats.brandAccuracy > 0.7 ? 20 : 3,
            
            // משקל יחידת מידה - רק אם יעיל (מעל 65%)
            sameUnit: stats.unitAccuracy > 0.65 ? 15 : 5,
            
            // משקל מילים משותפות - תמיד הכי חשוב, אבל משתנה לפי הפרדה
            sharedWords: Math.min(70, Math.max(40, stats.sharedWordsSeparation * 30)),
            
            // משקל מחיר - משתנה לפי כמה טוב זה מפריד
            priceRatio: Math.min(25, Math.max(10, stats.priceSeparation * 150)),
            
            // סף איכות דינמי לפי דיוק הקטגוריה
            qualityThreshold: Math.max(50, Math.min(80, stats.accuracy * 85))
        };
    });
    
    // חישוב ממוצע משוקלל של כל הקטגוריות
    const averageWeights = {
        sameBrand: 0,
        sameUnit: 0,
        sharedWords: 0,
        priceRatio: 0
    };
    
    let totalDecisions = 0;
    Object.keys(categoryStats).forEach(category => {
        const decisions = categoryStats[category].decisions;
        const weights = categoryWeights[category];
        
        averageWeights.sameBrand += weights.sameBrand * decisions;
        averageWeights.sameUnit += weights.sameUnit * decisions;
        averageWeights.sharedWords += weights.sharedWords * decisions;
        averageWeights.priceRatio += weights.priceRatio * decisions;
        
        totalDecisions += decisions;
    });
    
    // חישוב ממוצע
    Object.keys(averageWeights).forEach(key => {
        averageWeights[key] = Math.round(averageWeights[key] / totalDecisions);
    });
    
    learnedRules = {
        mode: selectedMode,
        combinedLearning: {
            totalSources: tinderReports.length,
            totalDecisions: combinedMetadata.totalDecisions,
            accuracy: (combinedMetadata.goodDecisions / combinedMetadata.totalDecisions * 100).toFixed(1),
            categories: Array.from(combinedMetadata.categories),
            sources: combinedMetadata.sources,
            bestCategory: bestCategory,
            bestAccuracy: (bestAccuracy * 100).toFixed(1)
        },
        
        // משקלים מותאמים מכל הקטגוריות
        weights: averageWeights,
        
        // הגדרות מותאמות
        qualityThreshold: selectedMode === 'improve' ? 
            Math.max(55, averageWeights.sharedWords * 0.8) : // במצב שיפור - יותר מקל
            Math.max(65, averageWeights.sharedWords * 0.9),   // במצב חדש - יותר מחמיר
            
        maxAlternatives: selectedMode === 'improve' ? 5 : 3, // יותר תחליפים במצב שיפור
        
        improvementMode: selectedMode === 'improve',
        
        // נתונים לכל קטגוריה
        categoryStats: categoryStats,
        categoryWeights: categoryWeights,
        
        // כללים מתקדמים
        adaptiveRules: {
            // הגדל משקל מילים משותפות לקטגוריות שזה עובד טוב שם
            boostSharedWords: Object.keys(categoryStats).filter(cat => 
                categoryStats[cat].sharedWordsSeparation > 1.0
            ),
            
            // הפחת משקל מותג לקטגוריות שזה לא עובד
            reduceBrandWeight: Object.keys(categoryStats).filter(cat => 
                categoryStats[cat].brandAccuracy < 0.65
            ),
            
            // התאם סף איכות לפי הקטגוריה הטובה ביותר
            adaptiveThreshold: true
        }
    };

    displayCombinedAnalysis();
}
        function startProcessing() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            
            // סימולציה של עיבוד
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('processingStatus').textContent = 
                    selectedMode === 'improve' ? 
                    `משפר תחליפים קיימים... ${progress}%` : 
                    `יוצר תחליפים חדשים... ${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('step4').classList.add('hidden');
                        document.getElementById('step5').classList.remove('hidden');
                        displayFinalResults();
                    }, 500);
                }
            }, 200);
        }

        function displayFinalResults() {
            const newAlternatives = selectedMode === 'improve' ? 850 : 2400;
            const totalProducts = Object.keys(productsData.products).length;
            
            document.getElementById('finalStats').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>📦 ${totalProducts} מוצרים עובדו</div>
                    ${selectedMode === 'improve' ? 
                        `<div>🔗 תחליפים קיימים: ${originalAlternativesCount}</div>
                         <div>✨ תחליפים חדשים: ${newAlternatives}</div>
                         <div>📈 סה"כ תחליפים: ${originalAlternativesCount + newAlternatives}</div>` :
                        `<div>✅ ${Math.floor(totalProducts * 0.8)} קיבלו תחליפים (80%)</div>
                         <div>🔗 ${newAlternatives} תחליפים נוצרו</div>`
                    }
                    <div>⏱️ 2.3 שניות עיבוד</div>
                </div>
            `;
            
            document.getElementById('learnedRules').innerHTML = `
                <div class="text-sm space-y-1">
                    <div>🧠 למידה מ-${learnedRules.combinedLearning.totalSources} מקורות</div>
                    <div>🎯 דיוק כללי: ${learnedRules.combinedLearning.accuracy}%</div>
                    <div>📊 סף איכות: ${learnedRules.qualityThreshold}%</div>
                    <div>🏷️ קטגוריות: ${learnedRules.combinedLearning.categories.join(', ')}</div>
                </div>
            `;
            
            if (selectedMode === 'improve') {
                document.getElementById('comparisonResults').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div>📊 ${((newAlternatives / originalAlternativesCount) * 100).toFixed(0)}% שיפור בכמות התחליפים</div>
                        <div>⭐ איכות משופרת על בסיס ${learnedRules.combinedLearning.totalDecisions} החלטות</div>
                        <div>🔄 תחליפים קיימים נשמרו ושופרו</div>
                        <div>✨ תחליפים חדשים נוספו במקומות שהיו חסרים</div>
                    </div>
                `;
            } else {
                document.getElementById('comparisonResults').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div>🆕 קובץ חדש נוצר מאפס</div>
                        <div>🎯 ${newAlternatives} תחליפים איכותיים</div>
                        <div>📈 מבוסס על למידה משולבת</div>
                    </div>
                `;
            }
        }

        function downloadResults() {
            alert(`הורדת קובץ ${selectedMode === 'improve' ? 'משופר' : 'חדש'}!`);
        }

        function downloadReport() {
            alert('הורדת דוח שיפורים מפורט!');
        }

        function resetAll() {
            location.reload();
        }
    </script>
</body>
</html>
